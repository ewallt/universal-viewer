<!--  viewer.html  (complete file)  -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Behold Your God — Viewer</title>

  <!-- ---------- minimal fallback palette (overridden by themes.json) ---------- -->
  <style>
    :root{
      --text-primary:#ecf0f1; --text-secondary:#90caf9;
      --accent-primary:#64b5f6; --accent-secondary:#42a5f5;
      --background-gradient:linear-gradient(135deg,#0a0a23,#2e2e5e);
      --surface-color:rgba(0,0,0,.6); --surface-color-secondary:rgba(0,0,0,.5);
      --border-color:rgba(255,255,255,.3); --border-color-accent:rgba(100,181,246,.4);
      --header-border-bottom:1px solid var(--border-color);
      --component-backdrop-filter:blur(15px); --component-box-shadow:0 15px 35px rgba(0,0,0,.3);
    }
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:Georgia,serif;line-height:1.6;color:var(--text-primary);
         background:var(--background-gradient);min-height:100vh;
         transition:background .5s,color .5s;}
    .container{max-width:1200px;margin:0 auto;padding:20px;}

    /* header / nav / panel style */
    .header{background:var(--surface-color);border-radius:20px;padding:30px;margin-bottom:30px;
            backdrop-filter:var(--component-backdrop-filter);box-shadow:var(--component-box-shadow);
            border:var(--header-border-bottom);text-align:center;}
    .book-title{font-size:2.5em;font-weight:bold;}
    .nav-tabs{display:flex;justify-content:center;gap:15px;margin-bottom:30px;flex-wrap:wrap;}
    .tab-button{background:var(--surface-color-secondary);border:1px solid var(--border-color);
                color:var(--text-primary);padding:12px 28px;border-radius:50px;cursor:pointer;
                transition:.3s;box-shadow:0 5px 15px rgba(0,0,0,.2);}
    .tab-button.active{
      font-weight:bold;border-color:var(--accent-primary);color:var(--accent-primary);
      background:var(--tab-active-bg,linear-gradient(135deg,#1a1a3a,#2e2e5e));
    }
    .content-panel{background:var(--surface-color);border:1px solid var(--border-color);
                   border-radius:20px;padding:30px;box-shadow:var(--component-box-shadow);
                   display:none;}
    .content-panel.active{display:block;}

    /* reusable chips */
    .central-thesis,.warning-highlight,.conclusion-box,.scripture-ref,
    .quote,.concept-card,.argument-point,.ref-item{
      background:var(--surface-color-secondary);border:1px solid var(--border-color-accent);
      padding:15px;border-radius:10px;margin:15px 0;border-left:4px solid var(--accent-primary);}
    .quote{font-style:italic;} .concept-card ul{padding-left:25px}

    /* reference pop-up */
    .reference-detail-card{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
                           width:min(90%,700px);max-height:80vh;overflow:auto;
                           background:var(--surface-color);border:1px solid var(--border-color);
                           border-radius:20px;padding:30px;box-shadow:var(--component-box-shadow);
                           z-index:1001;}
    .close-ref-btn{position:absolute;top:12px;right:12px;border:none;background:transparent;
                   color:var(--accent-primary);font-size:1.6rem;cursor:pointer;}
  </style>

  <!-- ---------- theme bootstrap (creates CSS vars & buttons) ---------- -->
  <script type="module">
    (async()=>{
      try{
        const r=await fetch('data/themes.json');if(!r.ok)throw new Error('themes.json missing');
        const j=await r.json();

        /* build CSS variables for every theme */
        let css='';
        for(const id in j.themes){
          css+=`body.theme-${id}{`;
          for(const[k,v]of Object.entries(j.themes[id]))css+=`${k}:${v};`;
          css+='}';
        }
        document.head.appendChild(Object.assign(document.createElement('style'),{textContent:css}));

        /* build theme-picker buttons */
        const host=document.getElementById('theme-buttons');
        host.innerHTML=(j.meta?.themeList||Object.keys(j.themes)).map(t=>{
          const id  =typeof t==='string'?t:t.id;
          const name=typeof t==='string'?id:t.name||id;
          const bg  =j.themes[id]['--background-gradient']||'#444';
          return `<button class="theme-btn" data-theme="${id}" title="${name}"
                    style="width:40px;height:40px;background:${bg};border:2px solid rgba(255,255,255,.7);
                           border-radius:50%;cursor:pointer;box-shadow:0 5px 15px rgba(0,0,0,.3);"></button>`;
        }).join('');

        /* apply default theme */
        document.body.className=`theme-${j.meta?.defaultTheme||'original'}`;
      }catch(e){console.error('theme bootstrap failed',e);}
    })();
  </script>
</head>

<body>
  <!-- theme picker -->
  <div id="theme-buttons"
       style="position:fixed;top:15px;right:20px;display:flex;gap:10px;z-index:1002;"></div>

  <div class="container">
    <header class="header">
      <h1 class="book-title">Loading…</h1>
      <div class="chapter-info"></div>
      <div class="page-range"></div>
      <a href="index.html" class="back-to-index-link">&larr; Table of Contents</a>
    </header>

    <nav id="nav-tabs-container" class="nav-tabs"></nav>

    <main id="main-content-area">
      <div class="content-panel active" style="text-align:center;"><h2>Loading…</h2></div>
    </main>
  </div>

  <script>
    /* ------------ globals & renderers (unchanged) ------------ */
    let referenceData={};

    const RENDERER_LIBRARY={
      'renderer-thesis':s=>`
        <div class="central-thesis">${s.central_thesis}</div>
        <div class="warning-highlight">${s.key_statement}</div>
        <div class="concept-card"><h3>${s.foundational_principles.title}</h3>
          <ul>${s.foundational_principles.points.map(p=>`<li>${p}</li>`).join('')}</ul>
        </div>`,

      'renderer-points-list':s=>s.points.map(p=>`
        <div class="argument-point">
          <h3 class="argument-title">${p.title}</h3><p>${p.explanation}</p>
          ${p.key_insight?`<p><em>${p.key_insight}</em></p>`:''}
          ${(p.quotes||[]).map(q=>{
            const cls=q.type==='scripture'?'scripture-ref':
                      q.type==='warning'  ?'warning-highlight':'quote';
            return `<div class="${cls}">${q.text}<br><span class="quote-source">${q.source}</span></div>`;
          }).join('')}
        </div>`).join(''),

      'renderer-definitions-list':s=>s.points.map(c=>`
        <div class="concept-card"><span class="concept-title">${c.title}</span>: ${c.definition}</div>`
      ).join(''),

      'renderer-list-detail':s=>{
        const row=r=>`<div class="ref-item clickable-ref" data-ref-id="${r.id||''}">${r.text}</div>`;
        const list=[].concat(s.items||[],s.scripture||[],s.other||[],s.points||[]).map(row).join('');
        return `<div id="referenceList">${list}</div>
                <div id="referenceDetailCard" class="reference-detail-card" style="display:none;">
                  <button class="close-ref-btn" aria-label="Close">&times;</button>
                  <h3 id="refDetailTitle"></h3>
                  <div id="refDetailContent"></div>
                </div>`;
      },

      'renderer-conclusion-list':s=>s.points.map(p=>{
        const cls=p.type==='scripture'?'scripture-ref':
                  p.type==='thesis'   ?'central-thesis':'conclusion-box';
        return `<div class="${cls}"><h3>${p.title}</h3><p>${p.content}</p></div>`;
      }).join('')
    };

    /* ------------ helpers ------------ */
    const showTab=(id,btn)=>{
      document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('.content-panel').forEach(p=>p.classList.remove('active'));
      btn.classList.add('active');document.getElementById(id).classList.add('active');
    };

    const showRef=id=>{
      const d=referenceData[id];if(!d)return;
      document.getElementById('refDetailTitle').textContent=d.title;
      document.getElementById('refDetailContent').innerHTML=d.content||'';
      document.getElementById('referenceList').style.display='none';
      document.getElementById('referenceDetailCard').style.display='block';
    };
    const hideRef=()=>{
      document.getElementById('referenceDetailCard').style.display='none';
      document.getElementById('referenceList').style.display='block';
    };

    /* ------------ render entry ------------ */
    function renderEntry(entry,schema,num){
      const sections=[...schema.defaultSections];
      Object.keys(entry).forEach(sec=>{
        if(schema.sectionRenderers[sec]&&!sections.includes(sec))sections.push(sec);
      });

      document.title=`${schema.projectName} — ${schema.entryLabel} ${num}`;
      document.querySelector('.book-title').textContent=schema.projectName;
      document.querySelector('.chapter-info').textContent=
        `${schema.entryLabel} ${num}: ${entry.title}`;
      document.querySelector('.page-range').textContent=entry.pageRange||'';
      referenceData=entry.referenceData||{};

      document.getElementById('nav-tabs-container').innerHTML=
        sections.filter(sec=>entry[sec]).map(sec=>
          `<button class="tab-button" data-tab="${sec}">
             ${schema.sectionLabels[sec]||sec}
           </button>`).join('');

      document.getElementById('main-content-area').innerHTML=
        sections.filter(sec=>entry[sec]).map(sec=>{
          const fn=RENDERER_LIBRARY[schema.sectionRenderers[sec]];
          return `<div class="content-panel" id="${sec}">
                    <h2 class="section-title">${entry[sec].title}</h2>
                    ${fn ? fn(entry[sec]) : `<p>No renderer for ${sec}</p>`}
                  </div>`;
        }).join('');

      /* hero image */
      const hero=document.createElement('img');
      hero.id='hero-img';
      hero.style.cssText='width:100%;height:250px;object-fit:cover;border-radius:20px;display:block;';
      hero.src=entry.heroImage||'';
      const head=document.querySelector('.header');
      head.parentNode.insertBefore(hero,head);

      const first=document.querySelector('.tab-button');
      if(first)showTab(first.dataset.tab,first);
    }

    /* ------------ init ------------ */
    async function init(){
      const rawId=new URLSearchParams(location.search).get('id')||'content1';
      const num  =rawId.replace(/^content/,'');
      try{
        const [entryRes,schemaRes]=await Promise.all([
          fetch(`data/contents/${rawId}.json`),
          fetch('data/schema.json')
        ]);
        if(!entryRes.ok)throw new Error(`${rawId}.json missing`);
        if(!schemaRes.ok)throw new Error('schema.json missing');
        renderEntry(await entryRes.json(),await schemaRes.json(),num);
      }catch(e){
        console.error(e);
        document.getElementById('main-content-area').innerHTML=
          `<div class="content-panel active" style="color:#ff8a80;">
             <h2>Error Loading Page</h2><p>${e.message}</p></div>`;
      }
    }

    /* ------------ listeners ------------ */
    document.addEventListener('DOMContentLoaded',()=>{
      init();
      document.body.addEventListener('click',e=>{
        if(e.target.closest('.tab-button'))    return showTab(e.target.closest('.tab-button').dataset.tab,e.target.closest('.tab-button'));
        if(e.target.closest('.clickable-ref')) return showRef(e.target.closest('.clickable-ref').dataset.refId);
        if(e.target.closest('.close-ref-btn')) return hideRef();
        if(e.target.closest('.theme-btn'))     return document.body.className=`theme-${e.target.closest('.theme-btn').dataset.theme}`;
      });
    });
  </script>
</body>
</html>
