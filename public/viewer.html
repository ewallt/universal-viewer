<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Viewer</title>

  <!-- ---------- minimal fallback palette (overridden by themes.json) ---------- -->
  <style>
    :root{
      --text-primary:#ecf0f1; --text-secondary:#90caf9;
      --accent-primary:#64b5f6; --accent-secondary:#42a5f5;
      --background-gradient:linear-gradient(135deg,#0a0a23,#2e2e5e);
      --surface-color:rgba(0,0,0,.6); --surface-color-secondary:rgba(0,0,0,.5);
      --border-color:rgba(255,255,255,.3); --border-color-accent:rgba(100,181,246,.4);
      --header-border-bottom:1px solid var(--border-color);
      --component-backdrop-filter:blur(15px); --component-box-shadow:0 15px 35px rgba(0,0,0,.3);
    }
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:Georgia,serif;line-height:1.6;color:var(--text-primary);
         background:var(--background-gradient);min-height:100vh;
         transition:background .5s,color .5s;}
    .container{max-width:1200px;margin:0 auto;padding:20px;}

    /* header / nav / panel style (unchanged) */
    .header{background:var(--surface-color);border-radius:20px;padding:30px;margin-bottom:30px;
            backdrop-filter:var(--component-backdrop-filter);box-shadow:var(--component-box-shadow);
            border:var(--header-border-bottom);text-align:center;}
    .book-title{font-size:2.5em;font-weight:bold;}
    .nav-tabs{display:flex;justify-content:center;gap:15px;margin-bottom:30px;flex-wrap:wrap;}
    .tab-button{background:var(--surface-color-secondary);border:1px solid var(--border-color);
                color:var(--text-primary);padding:12px 28px;border-radius:50px;cursor:pointer;
                transition:.3s;box-shadow:0 5px 15px rgba(0,0,0,.2);}
    .tab-button.active{font-weight:bold;border-color:var(--accent-primary);color:var(--accent-primary);
                       background:linear-gradient(135deg,#1a1a3a,#2e2e5e);}
    body.theme-stately .tab-button.active { 
      background:linear-gradient(45deg,#003366,#004080);
      color:white;border-color:var(--accent-primary); 
    }
    .content-panel{background:var(--surface-color);border:1px solid var(--border-color);
                   border-radius:20px;padding:30px;box-shadow:var(--component-box-shadow);
                   display:none;}
    .content-panel.active{display:block;}

    /* back to index link styling */
    .back-to-index-link { 
      display:block;text-align:center;margin-top:20px;
      color:var(--text-secondary);text-decoration:none;font-size:1.1em;
      transition:color .3s ease; 
    }
    .back-to-index-link:hover { 
      text-decoration:underline;color:var(--text-primary); 
    }
    .theme-stately .back-to-index-link { 
      color:#465A70; 
    }
    .theme-stately .back-to-index-link:hover { 
      color:var(--accent-primary); 
    }

    /* reusable chips */
    .central-thesis,.warning-highlight,.conclusion-box,.scripture-ref,
    .quote,.concept-card,.argument-point,.ref-item{
      background:var(--surface-color-secondary);border:1px solid var(--border-color-accent);
      padding:15px;border-radius:10px;margin:15px 0;border-left:4px solid var(--accent-primary);}
    .quote{font-style:italic;} .concept-card ul{padding-left:25px;}

    /* reference detail card styling */
    .reference-detail-card{background:var(--surface-color);border:1px solid var(--border-color);
                           border-radius:20px;padding:30px;box-shadow:var(--component-box-shadow);}
    .close-ref-btn{position:absolute;top:30px;right:30px;background:var(--surface-color-secondary);
                   border:1px solid var(--border-color);color:var(--text-primary);font-size:1.5em;
                   width:40px;height:40px;border-radius:50%;cursor:pointer;transition:all .3s ease;
                   display:flex;align-items:center;justify-content:center;z-index:910;}
    .ref-detail-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;}
    .ref-detail-content .verse-text{background:var(--surface-color-secondary);border:1px solid var(--border-color-accent);
                                    border-left:4px solid var(--accent-primary);padding:20px;border-radius:10px;
                                    margin:15px 0;font-style:italic;}
  </style>

  <!-- ---------- theme bootstrap (builds CSS vars from themes.json) ---------- -->
  <script type="module">
    (async()=>{
      try{
        const r=await fetch('data/themes.json');if(!r.ok)throw new Error;
        const j=await r.json();let css='';
        for(const id in j.themes){
          css+=`body.theme-${id}{`;
          for(const[k,v]of Object.entries(j.themes[id]))css+=`${k}:${v};`;
          css+='}';
        }
        const st=document.createElement('style');st.textContent=css;document.head.appendChild(st);
        document.body.className=`theme-${j.meta?.defaultTheme||'original'}`;
      }catch(e){console.error('theme bootstrap failed',e);}
    })();
  </script>
</head>

<body>
  <!-- theme picker -->
  <div style="position:fixed;top:15px;right:20px;display:flex;gap:10px;z-index:1002;">
    <button class="theme-btn" data-theme="original" title="Cosmic Night"
            style="width:40px;height:40px;background:linear-gradient(135deg,#1a1a3a,#64b5f6);"></button>
    <button class="theme-btn" data-theme="stately"  title="Stately"
            style="width:40px;height:40px;background:#ffffff;"></button>
    <button class="theme-btn" data-theme="forest"   title="Forest"
            style="width:40px;height:40px;background:linear-gradient(135deg,#2a4c3a,#58cdaa);"></button>
  </div>

  <div class="container">
    <section class="hero-banner" style="margin-bottom:30px;border-radius:20px;overflow:hidden;box-shadow:var(--component-box-shadow);background:#333;min-height:250px;display:flex;align-items:center;justify-content:center;">
        <img id="hero-img" 
             src=""
             style="width:100%;height:250px;object-fit:cover;display:block;">
    </section>

    <header class="header">
      <h1 class="book-title">Loading…</h1>
      <div class="chapter-info"></div>
      <div class="page-range"></div>
      <a href="index.html" class="back-to-index-link">&larr; Table of Contents</a>
    </header>

    <nav id="nav-tabs-container" class="nav-tabs"></nav>

    <main id="main-content-area">
      <div class="content-panel active" style="text-align:center;"><h2>Loading…</h2></div>
    </main>
  </div>

  <script>
    /* ------------ global ------------ */
    let referenceData={};

    /* ------------ renderer library ------------ */
    const RENDERER_LIBRARY={
      'renderer-thesis':s=>`
        <div class="central-thesis">${s.central_thesis}</div>
        <div class="warning-highlight">${s.key_statement}</div>
        <div class="concept-card"><h3>${s.foundational_principles.title}</h3>
          <ul>${s.foundational_principles.points.map(p=>`<li>${p}</li>`).join('')}</ul>
        </div>`,

      'renderer-points-list':s=>s.points.map(p=>`
        <div class="argument-point">
          <h3 class="argument-title">${p.title}</h3><p>${p.explanation}</p>
          ${p.key_insight?`<p><em>${p.key_insight}</em></p>`:''}
          ${(p.quotes||[]).map(q=>{
            const cls=q.type==='scripture'?'scripture-ref':
                      q.type==='warning'  ?'warning-highlight':'quote';
            return `<div class="${cls}">${q.text}<br><span class="quote-source">${q.source}</span></div>`;
          }).join('')}
        </div>`).join(''),

      'renderer-definitions-list':s=>s.points.map(c=>`
        <div class="concept-card"><span class="concept-title">${c.title}</span>: ${c.definition}</div>`
      ).join(''),

      /* ---------- updated list-with-detail renderer ---------- */
      'renderer-list-detail':s=>{
        const row=r=>`<div class="ref-item clickable-ref" data-ref-id="${r.id||''}">${r.text}</div>`;
        const list = [].concat(s.items||[],s.scripture||[],s.other||[],s.points||[]).map(row).join('');
        return `<div id="referenceList">
                  ${list}
                </div>
                <div id="referenceDetailCard" class="reference-detail-card" style="display:none;position:relative;">
                  <button class="close-ref-btn">&times;</button>
                  <div class="ref-detail-header">
                    <span id="refDetailTitle"></span>
                  </div>
                  <div id="refDetailContent" class="ref-detail-content"></div>
                </div>`;
      },

      'renderer-conclusion-list':s=>s.points.map(p=>{
        const cls=p.type==='scripture'?'scripture-ref':
                  p.type==='thesis'   ?'central-thesis':'conclusion-box';
        return `<div class="${cls}"><h3>${p.title}</h3><p>${p.content}</p></div>`;
      }).join('')
    };

    /* ------------ helpers ------------ */
    const showTab=(id,btn)=>{
      document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('.content-panel').forEach(p=>p.classList.remove('active'));
      btn.classList.add('active');document.getElementById(id).classList.add('active');
    };

    const showReference=(refId)=>{
      const detailCard = document.getElementById('referenceDetailCard');
      if (!detailCard) return;
      const refTitle = document.querySelector('#refDetailTitle');
      const refContent = document.querySelector('#refDetailContent');
      const referenceList = document.getElementById('referenceList');
      const data = referenceData[refId];
      if (!data || !refTitle || !refContent) return;

      refTitle.textContent = data.title;
      refContent.innerHTML = data.content;
      if (referenceList) referenceList.style.display = 'none';
      detailCard.style.display = 'block';
    };

    const hideReference=()=>{
      const detailCard = document.getElementById('referenceDetailCard');
      const referenceList = document.getElementById('referenceList');
      if (detailCard) detailCard.style.display = 'none';
      if (referenceList) referenceList.style.display = 'block';
    };

    /* ------------ render entry ------------ */
    function renderEntry(entry,schema,num){
      const sections=[...schema.defaultSections];
      Object.keys(entry).forEach(sec=>{
        if(schema.sectionRenderers[sec]&&!sections.includes(sec))sections.push(sec);
      });

      document.title=`${schema.projectName} — ${schema.entryLabel} ${num}`;
      document.querySelector('title').textContent = `${schema.projectName} — Viewer`;
      document.querySelector('.book-title').textContent=schema.projectName;
      document.querySelector('.chapter-info').textContent=
        `${schema.entryLabel} ${num}: ${entry.title}`;
      document.querySelector('.page-range').textContent=entry.pageRange||'';
      referenceData=entry.referenceData||{};

      document.getElementById('nav-tabs-container').innerHTML=
        sections.filter(sec=>entry[sec]).map(sec=>
          `<button class="tab-button" data-tab="${sec}">
             ${schema.sectionLabels[sec]||sec}
           </button>`).join('');

      document.getElementById('main-content-area').innerHTML=
        sections.filter(sec=>entry[sec]).map(sec=>{
          const fn=RENDERER_LIBRARY[schema.sectionRenderers[sec]];
          return `<div class="content-panel" id="${sec}">
                    <h2 class="section-title">${entry[sec].title}</h2>
                    ${fn ? fn(entry[sec]) : `<p>No renderer for ${sec}</p>`}
                  </div>`;
        }).join('');

      // Set hero image AFTER HTML is rendered
      const heroImg = document.getElementById('hero-img');
      if (heroImg && entry.heroImage) {
        heroImg.src = entry.heroImage;
      }

      const first=document.querySelector('.tab-button');
      if(first)showTab(first.dataset.tab,first);
    }

    /* ------------ init ------------ */
    async function init(){
      const rawId=new URLSearchParams(location.search).get('id')||'content1';
      const num  =rawId.replace(/^content/,'');
      const main =document.getElementById('main-content-area');
      try{
        const [eRes,sRes]=await Promise.all([
          fetch(`data/contents/${rawId}.json`),
          fetch('data/schema.json')
        ]);
        if(!eRes.ok)throw new Error(`${rawId}.json missing`);
        if(!sRes.ok)throw new Error('schema.json missing');
        renderEntry(await eRes.json(),await sRes.json(),num);
      }catch(e){
        console.error(e);
        main.innerHTML=`<div class="content-panel active" style="color:#ff8a80;">
                          <h2>Error Loading Page</h2><p>${e.message}</p>`;
      }
    }

    /* ------------ listeners ------------ */
    document.addEventListener('DOMContentLoaded',()=>{
      init();
      document.body.addEventListener('click',e=>{
        const t=e.target.closest('.tab-button');    if(t)return showTab(t.dataset.tab,t);
        const r=e.target.closest('.clickable-ref'); if(r)return showReference(r.dataset.refId);
        const c=e.target.closest('.close-ref-btn'); if(c)return hideReference();
        const th=e.target.closest('.theme-btn');    if(th)return document.body.className=`theme-${th.dataset.theme}`;
      });
    });
  </script>
</body>
</html>