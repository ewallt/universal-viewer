<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Viewer</title>

  <!-- Load CSS files -->
  <link rel="stylesheet" href="styles/main.css">
  <link rel="stylesheet" href="" id="theme-css">

  <!-- Simple theme loading -->
  <script>
    // Simple theme loading function
    async function loadTheme(themeName) {
      const themeLink = document.getElementById('theme-css');
      themeLink.href = `styles/themes/${themeName}.css`;
      document.body.className = `theme-${themeName}`;
    }

    // Initialize themes when page loads
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        // Get saved theme or fetch default from themes.json
        const savedTheme = localStorage.getItem('userPreferredTheme');
        let defaultTheme = 'cosmic'; // fallback
        
        try {
          const themesResponse = await fetch('data/themes.json');
          if (themesResponse.ok) {
            const themesData = await themesResponse.json();
            defaultTheme = savedTheme || themesData.meta?.defaultTheme || 'cosmic';
            
            // Populate theme picker
            const picker = document.getElementById('theme-picker');
            if (picker && themesData.meta.themeList) {
              const themeStyles = {
                cosmic: 'linear-gradient(135deg,#1a1a3a,#64b5f6)',
                stately: '#ffffff',
                forest: 'linear-gradient(135deg,#2a4c3a,#58cdaa)'
              };
              
              themesData.meta.themeList.forEach(theme => {
                const btn = document.createElement('button');
                btn.className = 'theme-btn';
                btn.dataset.theme = theme.id;
                btn.title = theme.name;
                btn.style.cssText = `width:40px;height:40px;background:${themeStyles[theme.id] || '#ccc'};`;
                picker.appendChild(btn);
              });
            }
          }
        } catch (e) {
          console.log('Could not load themes.json, using fallback');
        }
        
        // Apply theme
        await loadTheme(defaultTheme);
        
      } catch (error) {
        console.error('Theme initialization failed:', error);
        // Fallback
        await loadTheme('cosmic');
      }
    });

    // Make loadTheme available globally
    window.loadTheme = loadTheme;
  </script>
</head>

<body>
  <!-- Theme picker -->
  <div id="theme-picker" style="position:fixed;top:15px;right:20px;display:flex;gap:10px;z-index:1002;">
  </div>

  <div class="container">
    <section class="hero-banner">
        <img id="hero-img" src="" style="width:100%;height:250px;object-fit:cover;display:block;">
    </section>

    <header class="header">
      <h1 class="primary-title">Loading…</h1>
      <div class="secondary-info"></div>
      <div class="tertiary-info"></div>
      <a href="index.html" class="navigation-link">← Table of Contents</a>
    </header>

    <nav id="nav-tabs-container" class="nav-tabs"></nav>

    <main id="main-content-area">
      <div class="content-panel active" style="text-align:center;"><h2>Loading…</h2></div>
    </main>
  </div>

  <script>
    /* ------------ global ------------ */
    let referenceData={};

    /* ------------ helpers ------------ */
    const showTab=(id,btn)=>{
      document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('.content-panel').forEach(p=>p.classList.remove('active'));
      btn.classList.add('active');document.getElementById(id).classList.add('active');
    };

    const showReference=(refId)=>{
      const detailCard = document.getElementById('referenceDetailCard');
      if (!detailCard) return;
      const refTitle = document.querySelector('#refDetailTitle');
      const refContent = document.querySelector('#refDetailContent');
      const referenceList = document.getElementById('referenceList');
      const data = referenceData[refId];
      if (!data || !refTitle || !refContent) return;

      refTitle.textContent = data.title;
      refContent.innerHTML = data.content;
      if (referenceList) referenceList.style.display = 'none';
      detailCard.style.display = 'block';
    };

    const hideReference=()=>{
      const detailCard = document.getElementById('referenceDetailCard');
      const referenceList = document.getElementById('referenceList');
      if (detailCard) detailCard.style.display = 'none';
      if (referenceList) referenceList.style.display = 'block';
    };

    /* ------------ render entry ------------ */
    function renderEntry(entry,schema,num){
      const sections=[...schema.defaultSections];
      Object.keys(entry).forEach(sec=>{
        if(schema.sectionRenderers[sec]&&!sections.includes(sec))sections.push(sec);
      });

      document.title=`${schema.projectName} — ${schema.entryLabel} ${num}`;
      
      // Use schema to find elements
      const headerElements = schema.pageStructure.headerElements;
      const mainTitle = document.querySelector(`.${headerElements[0].class}`);
      const entryInfo = document.querySelector(`.${headerElements[1].class}`);
      const metaInfo = document.querySelector(`.${headerElements[2].class}`);
      
      if (mainTitle) mainTitle.textContent = schema.projectName;
      if (entryInfo) entryInfo.textContent = `${schema.entryLabel} ${num}: ${entry.title}`;
      if (metaInfo) metaInfo.textContent = entry.pageRange || '';
      referenceData=entry.referenceData||{};

      // Build renderers with schema context
      const RENDERER_LIBRARY={
        'renderer-thesis':s=>`
          <div class="${schema.cssClassMap['central-thesis']}">${s.central_thesis}</div>
          <div class="${schema.cssClassMap['warning-highlight']}">${s.key_statement}</div>
          <div class="${schema.cssClassMap['concept-card']}"><h3>${s.foundational_principles.title}</h3>
            <ul>${s.foundational_principles.points.map(p=>`<li>${p}</li>`).join('')}</ul>
          </div>`,

        'renderer-points-list':s=>s.points.map(p=>`
          <div class="${schema.cssClassMap['argument-point']}">
            <h3 class="argument-title">${p.title}</h3><p>${p.explanation}</p>
            ${p.key_insight?`<p><em>${p.key_insight}</em></p>`:''}
            ${(p.quotes||[]).map(q=>{
              const cls=q.type==='scripture'?schema.cssClassMap['scripture-ref']:
                        q.type==='warning'  ?schema.cssClassMap['warning-highlight']:schema.cssClassMap['quote'];
              return `<div class="${cls}">${q.text}<br><span class="quote-source">${q.source}</span></div>`;
            }).join('')}
          </div>`).join(''),

        'renderer-definitions-list':s=>s.points.map(c=>`
          <div class="${schema.cssClassMap['concept-card']}"><span class="concept-title">${c.title}</span>: ${c.definition}</div>`
        ).join(''),

        'renderer-list-detail':s=>{
          const row=r=>`<div class="${schema.cssClassMap['ref-item']} clickable-ref" data-ref-id="${r.id||''}">${r.text}</div>`;
          const list=[].concat(s.items||[],s.scripture||[],s.other||[],s.points||[]).map(row).join('');
          return `<div id="referenceList">${list}</div>
                  <div id="referenceDetailCard" class="reference-detail-card" style="display:none;">
                    <button class="close-ref-btn" aria-label="Close">&times;</button>
                    <h3 id="refDetailTitle"></h3>
                    <div id="refDetailContent"></div>
                  </div>`;
        },

        'renderer-conclusion-list':s=>s.points.map(p=>{
          const cls=p.type==='scripture'?schema.cssClassMap['scripture-ref']:
                    p.type==='thesis'   ?schema.cssClassMap['central-thesis']:schema.cssClassMap['conclusion-box'];
          return `<div class="${cls}"><h3>${p.title}</h3><p>${p.content}</p></div>`;
        }).join('')
      };

      document.getElementById('nav-tabs-container').innerHTML=
        sections.filter(sec=>entry[sec]).map(sec=>
          `<button class="tab-button" data-tab="${sec}">
             ${schema.sectionLabels[sec]||sec}
           </button>`).join('');

      document.getElementById('main-content-area').innerHTML=
        sections.filter(sec=>entry[sec]).map(sec=>{
          const fn=RENDERER_LIBRARY[schema.sectionRenderers[sec]];
          return `<div class="content-panel" id="${sec}">
                    <h2 class="section-title">${entry[sec].title}</h2>
                    ${fn ? fn(entry[sec]) : `<p>No renderer for ${sec}</p>`}
                  </div>`;
        }).join('');

      // Set hero image AFTER HTML is rendered
      const heroImg = document.getElementById('hero-img');
      if (heroImg && entry.heroImage) {
        heroImg.src = entry.heroImage;
      }

      const first=document.querySelector('.tab-button');
      if(first)showTab(first.dataset.tab,first);
    }

    /* ------------ init ------------ */
    async function init(){
      const rawId=new URLSearchParams(location.search).get('id')||'content1';
      const num  =rawId.replace(/^content/,'');
      const main =document.getElementById('main-content-area');
      try{
        const [eRes,sRes]=await Promise.all([
          fetch(`data/contents/${rawId}.json`),
          fetch('data/schema.json')
        ]);
        if(!eRes.ok)throw new Error(`${rawId}.json missing`);
        if(!sRes.ok)throw new Error('schema.json missing');
        renderEntry(await eRes.json(),await sRes.json(),num);
      }catch(e){
        console.error(e);
        main.innerHTML=`<div class="content-panel active" style="color:#ff8a80;">
                          <h2>Error Loading Page</h2><p>${e.message}</p>`;
      }
    }

    /* ------------ listeners ------------ */
    document.addEventListener('DOMContentLoaded',()=>{
      init();
      document.body.addEventListener('click', async e=>{
        const t=e.target.closest('.tab-button');    if(t)return showTab(t.dataset.tab,t);
        const r=e.target.closest('.clickable-ref'); if(r)return showReference(r.dataset.refId);
        const c=e.target.closest('.close-ref-btn'); if(c)return hideReference();
        const th=e.target.closest('.theme-btn');    
        if(th){
          const selectedTheme = th.dataset.theme;
          await window.loadTheme(selectedTheme);
          localStorage.setItem('userPreferredTheme', selectedTheme);
        }
      });
    });
  </script>
</body>
</html>